---
// src/pages/admin.astro
// No server-side fetch needed here, this is just a static form!
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Admin Dashboard | My Zero-JS Blog</title>
  </head>
  <body>
    <main>
      <a href="/" class="back-link">&larr; Back to Home</a>
      
      <h1>New Blog Post</h1>
      
      <form id="post-form">
        <div class="form-group">
          <label for="apiKey">Secret API Key</label>
          <input type="password" id="apiKey" required placeholder="Enter your master key..." />
        </div>

        <div class="form-group">
          <label for="title">Post Title</label>
          <input type="text" id="title" required placeholder="My Awesome Post" />
        </div>

        <div class="form-group">
          <label for="content">Markdown Content</label>
          <textarea id="content" rows="12" required placeholder="Write your **Markdown** here..."></textarea>
        </div>

        <button type="submit">Publish to Blog</button>
      </form>

      <div id="status-message"></div>
    </main>

    <script>
      // Client-side JavaScript to handle the form submission
      const form = document.getElementById('post-form');
      const statusDiv = document.getElementById('status-message');

      form.addEventListener('submit', async (e) => {
        e.preventDefault(); // Stop the page from reloading
        
        statusDiv.textContent = "Publishing to Turso and triggering Cloudflare...";
        statusDiv.className = "publishing";

        const apiKey = document.getElementById('apiKey').value;
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;

        try {
          // Send the request directly to your live Render API
          const response = await fetch("https://blog-api-grud.onrender.com/api/posts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-Key": apiKey
            },
            body: JSON.stringify({ title, content })
          });

          if (response.ok) {
            statusDiv.textContent = "Success! Post published. Cloudflare is rebuilding your site right now. It will be live in ~45 seconds.";
            statusDiv.className = "success";
            form.reset(); // Clear the form
          } else if (response.status === 401) {
            statusDiv.textContent = "Access Denied: Invalid API Key.";
            statusDiv.className = "error";
          } else {
            statusDiv.textContent = "Error: Something went wrong on the server.";
            statusDiv.className = "error";
          }
        } catch (err) {
          statusDiv.textContent = "Error: Could not connect to the API.";
          statusDiv.className = "error";
        }
      });
    </script>
  </body>
</html>

<style>
  :root {
    --bg-color: #0f111a;
    --text-color: #8f93a2;
    --heading-color: #fffffe;
    --accent-color: #c792ea;
    --card-bg: #1a1c23;
    --border-color: #292d3e;
  }

  body {
    font-family: 'Fira Code', 'Courier New', Courier, monospace;
    background-color: var(--bg-color);
    color: var(--text-color);
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem;
    line-height: 1.7;
  }

  h1 {
    color: var(--heading-color);
    margin-bottom: 2rem;
  }

  .back-link {
    color: var(--accent-color);
    text-decoration: none;
    margin-bottom: 2rem;
    display: inline-block;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--heading-color);
  }

  input, textarea {
    width: 100%;
    padding: 0.8rem;
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--heading-color);
    border-radius: 4px;
    font-family: inherit;
    box-sizing: border-box;
  }

  input:focus, textarea:focus {
    outline: none;
    border-color: var(--accent-color);
  }

  button {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-family: inherit;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    transition: opacity 0.2s;
  }

  button:hover {
    opacity: 0.9;
  }

  #status-message {
    margin-top: 1.5rem;
    padding: 1rem;
    border-radius: 4px;
    text-align: center;
    font-weight: bold;
    display: none; /* Hidden by default */
  }

  /* Status message modifiers */
  #status-message:not(:empty) {
    display: block;
  }
  .publishing { background-color: #292d3e; color: #82aaff; }
  .success { background-color: #1a2e23; color: #c3e88d; border: 1px solid #c3e88d; }
  .error { background-color: #3b1c1c; color: #ff5370; border: 1px solid #ff5370; }
</style>
